version: "3"

#networks:
#  esnet:

volumes:
  db:

services:

  api:
    build:
      context: "./api"
    image: registry.netlyt.io:5000/netlyt/cruzrdeploy
    container_name: cruzrdeploy
    volumes:
    #  - ./api:/app
      - db:/app/db
      - ./packages:/app/packages
      - ./data:/data  # Serve APK files
    ports:
      - 8006:5000
    environment:
      - TG_API_BASE=http://telegram-bot-api:8081
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHANNEL_ID=${TELEGRAM_CHANNEL_ID}

  # Telegram APK Streaming Server - tối ưu cho VPS 1GB RAM
  stream:
    build:
      context: "./api"
    container_name: vestool_stream
    command: python telegram_stream.py
    volumes:
      - ./api:/app
    ports:
      - 8088:8088
    environment:
      - TG_API_ID=${TG_API_ID}
      - TG_API_HASH=${TG_API_HASH}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHANNEL_ID=${TELEGRAM_CHANNEL_ID}
      - STREAM_PORT=8088
    depends_on:
      - telegram-bot-api
    restart: unless-stopped

  # Local Telegram Bot API server - hỗ trợ file tới 2GB
  telegram-bot-api:
    image: aiogram/telegram-bot-api:latest
    container_name: telegram-bot-api
    volumes:
      - ./telegram-bot-api-data:/var/lib/telegram-bot-api
    ports:
      - 8081:8081
    environment:
      - TELEGRAM_API_ID=${TG_API_ID}
      - TELEGRAM_API_HASH=${TG_API_HASH}
    restart: unless-stopped
    
  ui:
    build:
      context: "./webui"
    image: registry.netlyt.io:5000/netlyt/cruzrdeploy_ui
    container_name: cruzrdeploy_ui
    ports:
      - 8005:80
    volumes:
    #  - ./webui/build:/usr/share/nginx/html
      - ./conf/site.conf:/etc/nginx/conf.d/default.conf
      - ./data:/data  # Mount data folder cho nginx serve apps.json và APKs
    depends_on:
      - api
